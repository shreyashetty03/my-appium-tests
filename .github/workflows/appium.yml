name: Appium Tests (Windows)

on: [push, pull_request]

jobs:
  test:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Install dependencies
        run: npm install

      - name: Install Appium and UiAutomator2 driver
        run: |
          npm install -g appium@v2.18.0
          echo "$(npm bin -g)" | Out-File -Append $env:GITHUB_PATH
          appium -v
          appium driver install uiautomator2
 
      - name: Install Android system image
        shell: cmd
        run: |
          echo y | %ANDROID_SDK_ROOT%\cmdline-tools\latest\bin\sdkmanager.bat "system-images;android-31;google_apis;x86_64"

      - name: Accept licenses
        shell: cmd
        run: |
          echo y | %ANDROID_SDK_ROOT%\cmdline-tools\latest\bin\sdkmanager.bat --licenses
          
      - name: Create AVD
        shell: cmd
        run: |
          echo no | %ANDROID_SDK_ROOT%\cmdline-tools\latest\bin\avdmanager.bat create avd -n myNewEmulator -k "system-images;android-31;google_apis;x86_64" -d pixel

      - name: Start emulator
        shell: cmd
        run: |
          start /B "" %ANDROID_SDK_ROOT%\emulator\emulator.exe -avd myNewEmulator -no-audio -no-window -no-boot-anim -gpu swiftshader_indirect -no-snapshot-save
          echo Waiting for emulator to boot...
          for /l %%x in (1, 1, 30) do (
            %ANDROID_SDK_ROOT%\platform-tools\adb.exe shell getprop sys.boot_completed | findstr "1"
            if %errorlevel%==0 goto booted
            timeout /t 10
          )
          :booted
          echo Emulator booted.

      - name: Start Appium
        run: start /B appium --port 4723

      - name: Run tests
        run: node test3.js
